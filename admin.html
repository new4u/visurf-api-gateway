<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API ç®¡ç†åå° - ViSurf Gateway</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .header h1 {
      color: #667eea;
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
      font-size: 16px;
    }

    .api-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .api-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .api-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }

    .api-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .api-name {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }

    .api-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-enabled {
      background: #d4edda;
      color: #155724;
    }

    .status-disabled {
      background: #f8d7da;
      color: #721c24;
    }

    .api-info {
      margin-bottom: 20px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .info-label {
      color: #666;
      font-weight: 500;
    }

    .info-value {
      color: #333;
      font-weight: 600;
    }

    .endpoint {
      font-family: 'Courier New', monospace;
      background: #f8f9fa;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 13px;
    }

    .cost-input-group {
      margin-top: 20px;
    }

    .cost-input-group label {
      display: block;
      color: #666;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .input-with-button {
      display: flex;
      gap: 10px;
    }

    .cost-input {
      flex: 1;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .cost-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .billing-mode-selector {
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .radio-group {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }

    .radio-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #333;
    }

    .radio-label input[type="radio"] {
      cursor: pointer;
    }

    .time-price-input {
      margin-top: 10px;
      display: none;
    }

    .time-price-input.active {
      display: block;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .description {
      color: #666;
      font-size: 14px;
      line-height: 1.6;
      margin-top: 15px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .success {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .stats-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .stat-item {
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px;
      color: white;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .api-card {
      animation: fadeIn 0.5s ease-out;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ›ï¸ API ç®¡ç†åå°</h1>
      <p>å®æ—¶æŸ¥çœ‹å’Œä¿®æ”¹ API é…ç½®å‚æ•°</p>
    </div>

    <div id="message"></div>

    <div class="stats-card">
      <h2 style="color: #333; margin-bottom: 10px;">ğŸ“Š ç³»ç»Ÿç»Ÿè®¡</h2>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value" id="totalApis">-</div>
          <div class="stat-label">API æ€»æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="enabledApis">-</div>
          <div class="stat-label">å¯ç”¨ä¸­</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="avgCost">-</div>
          <div class="stat-label">å¹³å‡è´¹ç”¨</div>
        </div>
      </div>
    </div>

    <div id="loading" class="loading">
      <div>â³ åŠ è½½ä¸­...</div>
    </div>

    <div id="apiGrid" class="api-grid" style="display: none;"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:4000/api/v1/admin';
    let configs = [];

    // åŠ è½½æ‰€æœ‰ API é…ç½®
    async function loadConfigs() {
      try {
        const response = await fetch(`${API_BASE}/configs`);
        const result = await response.json();
        
        if (result.success) {
          configs = result.data.configs;
          renderConfigs();
          updateStats();
          document.getElementById('loading').style.display = 'none';
          document.getElementById('apiGrid').style.display = 'grid';
        } else {
          showMessage('åŠ è½½å¤±è´¥: ' + result.message, 'error');
        }
      } catch (error) {
        showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
      }
    }

    // æ¸²æŸ“ API é…ç½®å¡ç‰‡
    function renderConfigs() {
      const grid = document.getElementById('apiGrid');
      grid.innerHTML = '';

      configs.forEach(config => {
        const card = document.createElement('div');
        card.className = 'api-card';
        card.innerHTML = `
          <div class="api-header">
            <div class="api-name">${config.name}</div>
            <span class="api-status ${config.enabled ? 'status-enabled' : 'status-disabled'}">
              ${config.enabled ? 'âœ“ å¯ç”¨' : 'âœ— ç¦ç”¨'}
            </span>
          </div>

          <div class="api-info">
            <div class="info-row">
              <span class="info-label">API ID:</span>
              <span class="info-value">${config.id}</span>
            </div>
            <div class="info-row">
              <span class="info-label">ç«¯ç‚¹:</span>
              <span class="endpoint">${config.endpoint}</span>
            </div>
            <div class="info-row">
              <span class="info-label">è®¡è´¹æ¨¡å¼:</span>
              <span class="info-value">${config.billing_mode === 'per_time' ? 'â±ï¸ æŒ‰æ—¶é—´' : 'ğŸ”¢ æŒ‰æ¬¡'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">å½“å‰è´¹ç”¨:</span>
              <span class="info-value" style="color: #667eea; font-size: 18px;">
                ${config.billing_mode === 'per_time' 
                  ? `Â¥${(config.time_unit_price || 0).toFixed(3)}/ç§’` 
                  : `Â¥${config.cost.toFixed(2)}/æ¬¡`}
              </span>
            </div>
          </div>

          <div class="description">
            ${config.description || 'æš‚æ— æè¿°'}
          </div>

          <div class="billing-mode-selector">
            <label>è®¡è´¹æ¨¡å¼:</label>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="billing-mode-${config.id}" value="per_call" 
                  ${config.billing_mode === 'per_call' ? 'checked' : ''}
                  onchange="toggleBillingMode('${config.id}', 'per_call')">
                æŒ‰æ¬¡è®¡è´¹
              </label>
              <label class="radio-label">
                <input type="radio" name="billing-mode-${config.id}" value="per_time" 
                  ${config.billing_mode === 'per_time' ? 'checked' : ''}
                  onchange="toggleBillingMode('${config.id}', 'per_time')">
                æŒ‰æ—¶é—´è®¡è´¹
              </label>
            </div>
          </div>

          <div class="cost-input-group" id="per-call-input-${config.id}" 
               style="display: ${config.billing_mode === 'per_call' ? 'block' : 'none'}">
            <label>è´¹ç”¨ (å…ƒ/æ¬¡):</label>
            <div class="input-with-button">
              <input 
                type="number" 
                class="cost-input" 
                id="cost-${config.id}"
                value="${config.cost}"
                step="0.01"
                min="0"
                placeholder="è¾“å…¥è´¹ç”¨"
              />
              <button class="btn btn-primary" onclick="updateConfig('${config.id}')">
                ğŸ’¾ ä¿å­˜
              </button>
            </div>
          </div>

          <div class="cost-input-group" id="per-time-input-${config.id}" 
               style="display: ${config.billing_mode === 'per_time' ? 'block' : 'none'}">
            <label>æ—¶é—´å•ä»· (å…ƒ/ç§’):</label>
            <div class="input-with-button">
              <input 
                type="number" 
                class="cost-input" 
                id="time-price-${config.id}"
                value="${config.time_unit_price || 0}"
                step="0.001"
                min="0"
                placeholder="è¾“å…¥æ—¶é—´å•ä»·"
              />
              <button class="btn btn-primary" onclick="updateConfig('${config.id}')">
                ğŸ’¾ ä¿å­˜
              </button>
            </div>
          </div>

          <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button 
              class="btn ${config.enabled ? 'btn-danger' : 'btn-success'}" 
              onclick="toggleStatus('${config.id}', ${!config.enabled})"
              style="flex: 1;"
            >
              ${config.enabled ? 'ğŸš« ç¦ç”¨' : 'âœ… å¯ç”¨'}
            </button>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    function updateStats() {
      const total = configs.length;
      const enabled = configs.filter(c => c.enabled).length;
      const avgCost = configs.reduce((sum, c) => sum + c.cost, 0) / total;

      document.getElementById('totalApis').textContent = total;
      document.getElementById('enabledApis').textContent = enabled;
      document.getElementById('avgCost').textContent = 'Â¥' + avgCost.toFixed(2);
    }

    // åˆ‡æ¢è®¡è´¹æ¨¡å¼
    function toggleBillingMode(id, mode) {
      document.getElementById(`per-call-input-${id}`).style.display = mode === 'per_call' ? 'block' : 'none';
      document.getElementById(`per-time-input-${id}`).style.display = mode === 'per_time' ? 'block' : 'none';
    }

    // æ›´æ–°é…ç½®
    async function updateConfig(id) {
      const config = configs.find(c => c.id === id);
      const billingMode = document.querySelector(`input[name="billing-mode-${id}"]:checked`).value;
      
      const updates = {
        billing_mode: billingMode
      };

      if (billingMode === 'per_call') {
        const costInput = document.getElementById(`cost-${id}`);
        const newCost = parseFloat(costInput.value);
        if (isNaN(newCost) || newCost < 0) {
          showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„è´¹ç”¨é‡‘é¢', 'error');
          return;
        }
        updates.cost = newCost;
      } else {
        const timePriceInput = document.getElementById(`time-price-${id}`);
        const newTimePrice = parseFloat(timePriceInput.value);
        if (isNaN(newTimePrice) || newTimePrice < 0) {
          showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é—´å•ä»·', 'error');
          return;
        }
        updates.time_unit_price = newTimePrice;
      }

      try {
        const response = await fetch(`${API_BASE}/configs/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updates)
        });

        const result = await response.json();

        if (result.success) {
          const modeText = billingMode === 'per_time' ? 'æŒ‰æ—¶é—´è®¡è´¹' : 'æŒ‰æ¬¡è®¡è´¹';
          const priceText = billingMode === 'per_time' 
            ? `Â¥${updates.time_unit_price.toFixed(3)}/ç§’` 
            : `Â¥${updates.cost.toFixed(2)}/æ¬¡`;
          showMessage(`âœ… ${result.data.name} å·²æ›´æ–°ä¸º${modeText} ${priceText}`, 'success');
          await loadConfigs();
        } else {
          showMessage('æ›´æ–°å¤±è´¥: ' + result.message, 'error');
        }
      } catch (error) {
        showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
      }
    }

    // åˆ‡æ¢å¯ç”¨/ç¦ç”¨çŠ¶æ€
    async function toggleStatus(id, enabled) {
      try {
        const response = await fetch(`${API_BASE}/configs/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ enabled: enabled ? 1 : 0 })
        });

        const result = await response.json();

        if (result.success) {
          showMessage(`âœ… ${result.data.name} å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 'success');
          await loadConfigs();
        } else {
          showMessage('æ›´æ–°å¤±è´¥: ' + result.message, 'error');
        }
      } catch (error) {
        showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
      }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(text, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.className = type;
      messageDiv.textContent = text;
      messageDiv.style.display = 'block';

      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 3000);
    }

    // é¡µé¢åŠ è½½æ—¶è·å–é…ç½®
    window.addEventListener('DOMContentLoaded', loadConfigs);
  </script>
</body>
</html>
