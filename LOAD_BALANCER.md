# è´Ÿè½½å‡è¡¡æ¶æ„è®¾è®¡

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®¢æˆ·ç«¯è¯·æ±‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä¸­å¿ƒç½‘å…³ (Gateway Master)                   â”‚
â”‚  - æ¥æ”¶æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚                                    â”‚
â”‚  - ç”¨æˆ·è®¤è¯å’Œé‰´æƒ                                        â”‚
â”‚  - è®¡è´¹ç®¡ç†                                              â”‚
â”‚  - è´Ÿè½½å‡è¡¡è°ƒåº¦                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚            â”‚            â”‚
        â–¼            â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Worker 1 â”‚  â”‚ Worker 2 â”‚  â”‚ Worker 3 â”‚
â”‚ æ¸²æŸ“èŠ‚ç‚¹  â”‚  â”‚ è§£æèŠ‚ç‚¹  â”‚  â”‚ ç»„åˆèŠ‚ç‚¹  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚             â”‚             â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ç»“æœè¿”å›  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ æ ¸å¿ƒåŠŸèƒ½

### 1. å·¥ä½œèŠ‚ç‚¹ç®¡ç†
- **èŠ‚ç‚¹æ³¨å†Œ**: Worker å¯åŠ¨æ—¶å‘ Master æ³¨å†Œ
- **å¿ƒè·³æ£€æµ‹**: å®šæœŸå‘é€å¿ƒè·³ä¿æŒåœ¨çº¿çŠ¶æ€
- **å¥åº·æ£€æŸ¥**: Master å®šæœŸæ£€æŸ¥èŠ‚ç‚¹å¥åº·çŠ¶æ€
- **è‡ªåŠ¨å‰”é™¤**: è¶…æ—¶æœªå“åº”çš„èŠ‚ç‚¹è‡ªåŠ¨ä¸‹çº¿

### 2. è´Ÿè½½å‡è¡¡ç­–ç•¥

#### è½®è¯¢ (Round Robin)
```javascript
// ä¾æ¬¡åˆ†é…ç»™æ¯ä¸ªèŠ‚ç‚¹
Worker 1 â†’ Worker 2 â†’ Worker 3 â†’ Worker 1 ...
```

#### æœ€å°‘è¿æ¥ (Least Connections)
```javascript
// é€‰æ‹©å½“å‰è¿æ¥æ•°æœ€å°‘çš„èŠ‚ç‚¹
connections: { worker1: 5, worker2: 3, worker3: 7 }
â†’ é€‰æ‹© worker2
```

#### åŠ æƒè½®è¯¢ (Weighted Round Robin)
```javascript
// æ ¹æ®èŠ‚ç‚¹æ€§èƒ½åˆ†é…æƒé‡
{ worker1: weight=3, worker2: weight=2, worker3: weight=1 }
â†’ worker1 å¤„ç† 50%, worker2 å¤„ç† 33%, worker3 å¤„ç† 17%
```

#### å“åº”æ—¶é—´ (Response Time)
```javascript
// é€‰æ‹©å¹³å‡å“åº”æ—¶é—´æœ€çŸ­çš„èŠ‚ç‚¹
avgTime: { worker1: 120ms, worker2: 80ms, worker3: 150ms }
â†’ é€‰æ‹© worker2
```

### 3. æ•°æ®åº“è®¾è®¡

#### worker_nodes è¡¨
```sql
CREATE TABLE worker_nodes (
  id TEXT PRIMARY KEY,              -- èŠ‚ç‚¹ID
  name TEXT NOT NULL,               -- èŠ‚ç‚¹åç§°
  host TEXT NOT NULL,               -- ä¸»æœºåœ°å€
  port INTEGER NOT NULL,            -- ç«¯å£
  service_type TEXT NOT NULL,       -- æœåŠ¡ç±»å‹ (render/parse/combo)
  status TEXT DEFAULT 'online',     -- çŠ¶æ€ (online/offline/busy)
  weight INTEGER DEFAULT 1,         -- æƒé‡
  max_connections INTEGER DEFAULT 100,  -- æœ€å¤§è¿æ¥æ•°
  current_connections INTEGER DEFAULT 0, -- å½“å‰è¿æ¥æ•°
  total_requests INTEGER DEFAULT 0, -- æ€»è¯·æ±‚æ•°
  failed_requests INTEGER DEFAULT 0,-- å¤±è´¥è¯·æ±‚æ•°
  avg_response_time REAL DEFAULT 0, -- å¹³å‡å“åº”æ—¶é—´(ms)
  last_heartbeat TEXT,              -- æœ€åå¿ƒè·³æ—¶é—´
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now'))
);
```

#### worker_stats è¡¨
```sql
CREATE TABLE worker_stats (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  worker_id TEXT NOT NULL,
  requests INTEGER DEFAULT 0,       -- è¯·æ±‚æ•°
  success INTEGER DEFAULT 0,        -- æˆåŠŸæ•°
  failed INTEGER DEFAULT 0,         -- å¤±è´¥æ•°
  avg_time REAL DEFAULT 0,          -- å¹³å‡æ—¶é—´
  timestamp TEXT DEFAULT (datetime('now'))
);
```

## ğŸ”„ å·¥ä½œæµç¨‹

### 1. èŠ‚ç‚¹æ³¨å†Œæµç¨‹
```javascript
// Worker å¯åŠ¨
POST /api/v1/worker/register
{
  "name": "render-worker-1",
  "host": "192.168.1.100",
  "port": 5001,
  "serviceType": "render",
  "weight": 2
}

// Master å“åº”
{
  "success": true,
  "data": {
    "workerId": "worker-uuid-123",
    "heartbeatInterval": 30000  // 30ç§’
  }
}
```

### 2. å¿ƒè·³æœºåˆ¶
```javascript
// Worker æ¯30ç§’å‘é€å¿ƒè·³
POST /api/v1/worker/heartbeat
{
  "workerId": "worker-uuid-123",
  "status": "online",
  "currentConnections": 5,
  "cpuUsage": 45.2,
  "memoryUsage": 60.5
}
```

### 3. è¯·æ±‚åˆ†å‘æµç¨‹
```javascript
// 1. å®¢æˆ·ç«¯è¯·æ±‚åˆ°è¾¾ Master
POST /api/v1/render
Authorization: Bearer {api_key}

// 2. Master éªŒè¯ç”¨æˆ·èº«ä»½å’Œæƒé™
authenticateToken(req)

// 3. è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹
const worker = loadBalancer.selectWorker('render')

// 4. è½¬å‘è¯·æ±‚åˆ° Worker
const response = await axios.post(
  `http://${worker.host}:${worker.port}/render`,
  req.body
)

// 5. è®°å½•ç»Ÿè®¡å’Œè®¡è´¹
updateWorkerStats(worker.id, responseTime)
logUsage(userId, cost, startTime, endTime)

// 6. è¿”å›ç»“æœç»™å®¢æˆ·ç«¯
res.json(response.data)
```

## ğŸ¯ è´Ÿè½½å‡è¡¡ç®—æ³•å®ç°

### è½®è¯¢ç®—æ³•
```javascript
class RoundRobinBalancer {
  constructor() {
    this.currentIndex = 0;
  }
  
  selectWorker(workers) {
    if (workers.length === 0) return null;
    const worker = workers[this.currentIndex];
    this.currentIndex = (this.currentIndex + 1) % workers.length;
    return worker;
  }
}
```

### æœ€å°‘è¿æ¥ç®—æ³•
```javascript
class LeastConnectionsBalancer {
  selectWorker(workers) {
    if (workers.length === 0) return null;
    return workers.reduce((min, worker) => 
      worker.current_connections < min.current_connections ? worker : min
    );
  }
}
```

### åŠ æƒè½®è¯¢ç®—æ³•
```javascript
class WeightedRoundRobinBalancer {
  constructor() {
    this.currentWeights = new Map();
  }
  
  selectWorker(workers) {
    if (workers.length === 0) return null;
    
    let totalWeight = 0;
    let maxWeight = -1;
    let selectedWorker = null;
    
    for (const worker of workers) {
      const currentWeight = (this.currentWeights.get(worker.id) || 0) + worker.weight;
      this.currentWeights.set(worker.id, currentWeight);
      totalWeight += worker.weight;
      
      if (currentWeight > maxWeight) {
        maxWeight = currentWeight;
        selectedWorker = worker;
      }
    }
    
    if (selectedWorker) {
      this.currentWeights.set(
        selectedWorker.id, 
        this.currentWeights.get(selectedWorker.id) - totalWeight
      );
    }
    
    return selectedWorker;
  }
}
```

## ğŸ›¡ï¸ å®¹é”™æœºåˆ¶

### 1. èŠ‚ç‚¹å¥åº·æ£€æŸ¥
```javascript
// æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡æ‰€æœ‰èŠ‚ç‚¹
setInterval(() => {
  const now = Date.now();
  const timeout = 60000; // 60ç§’è¶…æ—¶
  
  for (const worker of workers) {
    const lastHeartbeat = new Date(worker.last_heartbeat).getTime();
    if (now - lastHeartbeat > timeout) {
      markWorkerOffline(worker.id);
    }
  }
}, 10000);
```

### 2. è¯·æ±‚é‡è¯•
```javascript
async function forwardRequest(worker, request, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      return await axios.post(
        `http://${worker.host}:${worker.port}${request.path}`,
        request.body,
        { timeout: 30000 }
      );
    } catch (error) {
      if (i === retries - 1) throw error;
      
      // æ ‡è®°èŠ‚ç‚¹å¤±è´¥ï¼Œé€‰æ‹©æ–°èŠ‚ç‚¹
      recordWorkerFailure(worker.id);
      worker = loadBalancer.selectWorker(request.serviceType);
    }
  }
}
```

### 3. ç†”æ–­æœºåˆ¶
```javascript
class CircuitBreaker {
  constructor(threshold = 5, timeout = 60000) {
    this.failures = new Map();
    this.threshold = threshold;
    this.timeout = timeout;
  }
  
  isOpen(workerId) {
    const failure = this.failures.get(workerId);
    if (!failure) return false;
    
    if (failure.count >= this.threshold) {
      if (Date.now() - failure.timestamp < this.timeout) {
        return true; // ç†”æ–­æ‰“å¼€
      } else {
        this.failures.delete(workerId); // è¶…æ—¶é‡ç½®
      }
    }
    return false;
  }
  
  recordFailure(workerId) {
    const failure = this.failures.get(workerId) || { count: 0, timestamp: Date.now() };
    failure.count++;
    failure.timestamp = Date.now();
    this.failures.set(workerId, failure);
  }
}
```

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### èŠ‚ç‚¹æŒ‡æ ‡
- åœ¨çº¿èŠ‚ç‚¹æ•°
- æ€»è¯·æ±‚æ•°
- å¹³å‡å“åº”æ—¶é—´
- é”™è¯¯ç‡
- CPU/å†…å­˜ä½¿ç”¨ç‡

### ç³»ç»ŸæŒ‡æ ‡
- è¯·æ±‚åˆ†å‘é€Ÿç‡
- è´Ÿè½½å‡è¡¡æ•ˆç‡
- èŠ‚ç‚¹æ•…éšœæ¬¡æ•°
- è¯·æ±‚é‡è¯•æ¬¡æ•°

## ğŸš€ éƒ¨ç½²æ–¹æ¡ˆ

### Master èŠ‚ç‚¹ (ä¸­å¿ƒç½‘å…³)
```bash
# ç«¯å£ 4000
node src/simple-server.js
```

### Worker èŠ‚ç‚¹ (å·¥ä½œèŠ‚ç‚¹)
```bash
# Render Worker - ç«¯å£ 5001
node src/worker-server.js --type=render --port=5001

# Parse Worker - ç«¯å£ 5002
node src/worker-server.js --type=parse --port=5002

# Combo Worker - ç«¯å£ 5003
node src/worker-server.js --type=combo --port=5003
```

### Docker Compose éƒ¨ç½²
```yaml
version: '3.8'

services:
  gateway-master:
    build: .
    ports:
      - "4000:4000"
    environment:
      - NODE_ENV=production
      - ROLE=master
    
  render-worker-1:
    build: .
    environment:
      - NODE_ENV=production
      - ROLE=worker
      - SERVICE_TYPE=render
      - MASTER_URL=http://gateway-master:4000
    
  render-worker-2:
    build: .
    environment:
      - NODE_ENV=production
      - ROLE=worker
      - SERVICE_TYPE=render
      - MASTER_URL=http://gateway-master:4000
```

## ğŸ”§ é…ç½®ç¤ºä¾‹

```javascript
// config/load-balancer.js
module.exports = {
  strategy: 'weighted-round-robin',  // è´Ÿè½½å‡è¡¡ç­–ç•¥
  healthCheck: {
    interval: 10000,      // å¥åº·æ£€æŸ¥é—´éš” (ms)
    timeout: 60000        // èŠ‚ç‚¹è¶…æ—¶æ—¶é—´ (ms)
  },
  retry: {
    maxRetries: 3,        // æœ€å¤§é‡è¯•æ¬¡æ•°
    timeout: 30000        // è¯·æ±‚è¶…æ—¶æ—¶é—´ (ms)
  },
  circuitBreaker: {
    threshold: 5,         // å¤±è´¥é˜ˆå€¼
    timeout: 60000        // ç†”æ–­è¶…æ—¶ (ms)
  }
};
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. è¿æ¥æ± 
```javascript
const agents = new Map();

function getAgent(worker) {
  const key = `${worker.host}:${worker.port}`;
  if (!agents.has(key)) {
    agents.set(key, new http.Agent({
      keepAlive: true,
      maxSockets: 100,
      maxFreeSockets: 10
    }));
  }
  return agents.get(key);
}
```

### 2. è¯·æ±‚ç¼“å­˜
```javascript
const cache = new LRU({
  max: 1000,
  ttl: 60000  // 1åˆ†é’Ÿ
});

function getCachedResponse(key) {
  return cache.get(key);
}
```

### 3. æ‰¹é‡å¤„ç†
```javascript
// åˆå¹¶å¤šä¸ªå°è¯·æ±‚ä¸ºä¸€ä¸ªæ‰¹é‡è¯·æ±‚
const batchQueue = [];
const BATCH_SIZE = 10;
const BATCH_TIMEOUT = 100; // ms

function addToBatch(request) {
  batchQueue.push(request);
  if (batchQueue.length >= BATCH_SIZE) {
    processBatch();
  }
}
```

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

- [ ] å®ç°èŠ‚ç‚¹æ³¨å†Œå’Œå¿ƒè·³æœºåˆ¶
- [ ] å®ç°è´Ÿè½½å‡è¡¡è°ƒåº¦å™¨
- [ ] ä¿®æ”¹ API è·¯ç”±æ”¯æŒèŠ‚ç‚¹åˆ†å‘
- [ ] æ·»åŠ èŠ‚ç‚¹ç®¡ç†ç•Œé¢
- [ ] å®ç°ç›‘æ§å’Œå‘Šè­¦
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
