# è´Ÿè½½å‡è¡¡ç³»ç»Ÿéƒ¨ç½²æŒ‡å—

## ğŸ“¦ éƒ¨ç½²æ¶æ„

### æ–¹æ¡ˆä¸€ï¼šå•æœºéƒ¨ç½²ï¼ˆå¼€å‘/æµ‹è¯•ç¯å¢ƒï¼‰

```
ä¸€å°æœåŠ¡å™¨
â”œâ”€â”€ Master (ç«¯å£ 4000)
â”œâ”€â”€ Worker 1 (ç«¯å£ 5001)
â”œâ”€â”€ Worker 2 (ç«¯å£ 5002)
â””â”€â”€ Worker 3 (ç«¯å£ 5003)
```

**é€‚ç”¨åœºæ™¯ï¼š** å¼€å‘æµ‹è¯•ã€å°æµé‡åº”ç”¨

### æ–¹æ¡ˆäºŒï¼šå¤šæœºéƒ¨ç½²ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰â­

```
æœåŠ¡å™¨ A (192.168.1.100)
â””â”€â”€ Master (ç«¯å£ 4000)

æœåŠ¡å™¨ B (192.168.1.101)
â”œâ”€â”€ Worker 1 (ç«¯å£ 5001)
â””â”€â”€ Worker 2 (ç«¯å£ 5002)

æœåŠ¡å™¨ C (192.168.1.102)
â”œâ”€â”€ Worker 3 (ç«¯å£ 5001)
â””â”€â”€ Worker 4 (ç«¯å£ 5002)
```

**é€‚ç”¨åœºæ™¯ï¼š** ç”Ÿäº§ç¯å¢ƒã€é«˜å¯ç”¨éœ€æ±‚

---

## ğŸš€ æ–¹æ¡ˆä¸€ï¼šå•æœºéƒ¨ç½²

### æ­¥éª¤ 1ï¼šå®‰è£…ä¾èµ–

```bash
cd visurf-api-gateway
npm install
```

### æ­¥éª¤ 2ï¼šé…ç½®ç¯å¢ƒå˜é‡

```bash
cp .env.development .env
nano .env
```

```env
JWT_SECRET=your-strong-secret-key-here
CLAUDE_API_KEY=your-claude-api-key
PORT=4000
NODE_ENV=production
```

### æ­¥éª¤ 3ï¼šä½¿ç”¨ PM2 å¯åŠ¨æœåŠ¡

**å®‰è£… PM2ï¼š**
```bash
npm install -g pm2
```

**å¯åŠ¨ Masterï¼š**
```bash
pm2 start src/simple-server.js --name "master" -- --port 4000
```

**å¯åŠ¨å¤šä¸ª Workerï¼š**
```bash
pm2 start worker-server.js --name "worker-render-1" -- --type=render --port=5001 --weight=2
pm2 start worker-server.js --name "worker-render-2" -- --type=render --port=5002 --weight=1
pm2 start worker-server.js --name "worker-parse-1" -- --type=parse --port=5003
pm2 start worker-server.js --name "worker-combo-1" -- --type=combo --port=5004
```

**æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ï¼š**
```bash
pm2 list
pm2 logs
```

**è®¾ç½®å¼€æœºè‡ªå¯ï¼š**
```bash
pm2 startup
pm2 save
```

---

## ğŸŒ æ–¹æ¡ˆäºŒï¼šå¤šæœºéƒ¨ç½²

### æœåŠ¡å™¨ Aï¼šéƒ¨ç½² Master

**1. ä¸Šä¼ ä»£ç åˆ°æœåŠ¡å™¨ï¼š**
```bash
scp -r visurf-api-gateway user@192.168.1.100:/opt/
```

**2. SSH ç™»å½•æœåŠ¡å™¨ Aï¼š**
```bash
ssh user@192.168.1.100
cd /opt/visurf-api-gateway
```

**3. å®‰è£…ä¾èµ–ï¼š**
```bash
npm install
```

**4. é…ç½®ç¯å¢ƒå˜é‡ï¼š**
```bash
nano .env
```

```env
JWT_SECRET=your-strong-secret-key
PORT=4000
NODE_ENV=production
```

**5. å¯åŠ¨ Masterï¼š**
```bash
pm2 start src/simple-server.js --name "master"
pm2 startup
pm2 save
```

**6. é…ç½®é˜²ç«å¢™ï¼ˆå¼€æ”¾ 4000 ç«¯å£ï¼‰ï¼š**
```bash
# Ubuntu/Debian
sudo ufw allow 4000

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=4000/tcp
sudo firewall-cmd --reload
```

### æœåŠ¡å™¨ Bï¼šéƒ¨ç½² Worker

**1. ä¸Šä¼ ä»£ç ï¼š**
```bash
scp -r visurf-api-gateway user@192.168.1.101:/opt/
```

**2. SSH ç™»å½•æœåŠ¡å™¨ Bï¼š**
```bash
ssh user@192.168.1.101
cd /opt/visurf-api-gateway
npm install
```

**3. å¯åŠ¨ Workerï¼ˆæŒ‡å‘ Master åœ°å€ï¼‰ï¼š**
```bash
pm2 start worker-server.js --name "worker-render-1" -- \
  --type=render \
  --port=5001 \
  --master=http://192.168.1.100:4000 \
  --weight=2

pm2 start worker-server.js --name "worker-render-2" -- \
  --type=render \
  --port=5002 \
  --master=http://192.168.1.100:4000 \
  --weight=1

pm2 startup
pm2 save
```

**4. é…ç½®é˜²ç«å¢™ï¼š**
```bash
sudo ufw allow 5001
sudo ufw allow 5002
```

### æœåŠ¡å™¨ Cï¼šéƒ¨ç½²æ›´å¤š Worker

é‡å¤æœåŠ¡å™¨ B çš„æ­¥éª¤ï¼Œä½¿ç”¨ä¸åŒçš„ç«¯å£ã€‚

---

## ğŸ³ æ–¹æ¡ˆä¸‰ï¼šDocker éƒ¨ç½²

### åˆ›å»º Dockerfile

**Master Dockerfileï¼š**
```dockerfile
FROM node:18-alpine

WORKDIR /app
COPY package*.json ./
RUN npm install --production

COPY . .

EXPOSE 4000
CMD ["node", "src/simple-server.js"]
```

**Worker Dockerfileï¼š**
```dockerfile
FROM node:18-alpine

WORKDIR /app
COPY package*.json ./
RUN npm install --production

COPY . .

EXPOSE 5001
CMD ["node", "worker-server.js"]
```

### ä½¿ç”¨ Docker Compose

**docker-compose.ymlï¼š**
```yaml
version: '3.8'

services:
  master:
    build: .
    dockerfile: Dockerfile
    ports:
      - "4000:4000"
    environment:
      - NODE_ENV=production
      - JWT_SECRET=your-secret-key
    volumes:
      - ./data:/app/data
    restart: unless-stopped

  worker-render-1:
    build: .
    dockerfile: Dockerfile.worker
    command: node worker-server.js --type=render --port=5001 --master=http://master:4000 --weight=2
    environment:
      - NODE_ENV=production
    depends_on:
      - master
    restart: unless-stopped

  worker-render-2:
    build: .
    dockerfile: Dockerfile.worker
    command: node worker-server.js --type=render --port=5001 --master=http://master:4000 --weight=1
    environment:
      - NODE_ENV=production
    depends_on:
      - master
    restart: unless-stopped

  worker-parse-1:
    build: .
    dockerfile: Dockerfile.worker
    command: node worker-server.js --type=parse --port=5001 --master=http://master:4000
    environment:
      - NODE_ENV=production
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
    depends_on:
      - master
    restart: unless-stopped
```

**å¯åŠ¨ï¼š**
```bash
docker-compose up -d
```

**æŸ¥çœ‹çŠ¶æ€ï¼š**
```bash
docker-compose ps
docker-compose logs -f
```

---

## ğŸ”§ Nginx åå‘ä»£ç†ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦ä½¿ç”¨åŸŸåè®¿é—®ï¼Œå¯ä»¥é…ç½® Nginxï¼š

```nginx
# /etc/nginx/sites-available/visurf-api

upstream master_backend {
    server 192.168.1.100:4000;
}

server {
    listen 80;
    server_name api.yourdomain.com;

    location / {
        proxy_pass http://master_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
}
```

**å¯ç”¨é…ç½®ï¼š**
```bash
sudo ln -s /etc/nginx/sites-available/visurf-api /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

### Master èŠ‚ç‚¹
- [ ] ä»£ç å·²ä¸Šä¼ 
- [ ] ä¾èµ–å·²å®‰è£… (`npm install`)
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½® (`.env`)
- [ ] æ•°æ®åº“ç›®å½•å­˜åœ¨ (`data/`)
- [ ] é˜²ç«å¢™å·²å¼€æ”¾ 4000 ç«¯å£
- [ ] æœåŠ¡å·²å¯åŠ¨ (`pm2 list`)
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡ (`curl http://localhost:4000/health`)

### Worker èŠ‚ç‚¹
- [ ] ä»£ç å·²ä¸Šä¼ 
- [ ] ä¾èµ–å·²å®‰è£…
- [ ] Master åœ°å€é…ç½®æ­£ç¡®
- [ ] é˜²ç«å¢™å·²å¼€æ”¾å¯¹åº”ç«¯å£
- [ ] æœåŠ¡å·²å¯åŠ¨
- [ ] å·²æ³¨å†Œåˆ° Master (`curl http://master:4000/api/v1/worker/list`)

---

## ğŸ” éªŒè¯éƒ¨ç½²

### 1. æ£€æŸ¥ Master çŠ¶æ€
```bash
curl http://192.168.1.100:4000/health
```

### 2. æ£€æŸ¥ Worker æ³¨å†Œ
```bash
curl http://192.168.1.100:4000/api/v1/worker/list
```

### 3. æµ‹è¯• API è°ƒç”¨
```bash
# æ³¨å†Œç”¨æˆ·
curl -X POST http://192.168.1.100:4000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "test123",
    "name": "Test User"
  }'

# ä½¿ç”¨è¿”å›çš„ API Key è°ƒç”¨æœåŠ¡
curl -X POST http://192.168.1.100:4000/api/v1/render \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -d '{
    "entities": [
      {"id": "1", "label": "æµ‹è¯•", "labelEn": "Test"}
    ],
    "relations": []
  }'
```

---

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### æŸ¥çœ‹æ—¥å¿—
```bash
# PM2 æ—¥å¿—
pm2 logs master
pm2 logs worker-render-1

# å®æ—¶æ—¥å¿—
pm2 logs --lines 100
```

### é‡å¯æœåŠ¡
```bash
# é‡å¯å•ä¸ªæœåŠ¡
pm2 restart master

# é‡å¯æ‰€æœ‰æœåŠ¡
pm2 restart all
```

### æŸ¥çœ‹èµ„æºä½¿ç”¨
```bash
pm2 monit
```

### æ›´æ–°ä»£ç 
```bash
# æ‹‰å–æœ€æ–°ä»£ç 
git pull

# é‡å¯æœåŠ¡
pm2 restart all
```

---

## ğŸš¨ å¸¸è§é—®é¢˜

### Worker æ— æ³•è¿æ¥ Masterï¼Ÿ
1. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§ï¼š`ping 192.168.1.100`
2. æ£€æŸ¥é˜²ç«å¢™ï¼š`telnet 192.168.1.100 4000`
3. æ£€æŸ¥ Master æ˜¯å¦è¿è¡Œï¼š`curl http://192.168.1.100:4000/health`

### ç«¯å£è¢«å ç”¨ï¼Ÿ
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
lsof -i :4000
netstat -tulpn | grep 4000

# æ€æ­»è¿›ç¨‹
kill -9 <PID>
```

### æ•°æ®åº“æƒé™é—®é¢˜ï¼Ÿ
```bash
# ç¡®ä¿æ•°æ®ç›®å½•æœ‰å†™æƒé™
chmod 755 data/
chown -R $USER:$USER data/
```

---

## ğŸ¯ æ¨èéƒ¨ç½²é…ç½®

### å°å‹åº”ç”¨ï¼ˆ< 1000 QPSï¼‰
```
1 å°æœåŠ¡å™¨
- Master (4000)
- 2-3 ä¸ª Worker (5001-5003)
```

### ä¸­å‹åº”ç”¨ï¼ˆ1000-10000 QPSï¼‰
```
3 å°æœåŠ¡å™¨
- æœåŠ¡å™¨ A: Master
- æœåŠ¡å™¨ B: 3-5 ä¸ª Worker
- æœåŠ¡å™¨ C: 3-5 ä¸ª Worker
```

### å¤§å‹åº”ç”¨ï¼ˆ> 10000 QPSï¼‰
```
5+ å°æœåŠ¡å™¨
- 2 å° Master (ä¸»å¤‡æˆ–è´Ÿè½½å‡è¡¡)
- 3+ å° Worker æœåŠ¡å™¨ï¼Œæ¯å°å¤šä¸ª Worker
- ä½¿ç”¨ Nginx/HAProxy åšè´Ÿè½½å‡è¡¡
```

---

**éƒ¨ç½²å®Œæˆåï¼Œè®°å¾—è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½ï¼š**
```bash
node test-load-balancer.js
```
